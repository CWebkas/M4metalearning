---
title: "Reproducibility: Combination of Forecast Methods by Feature-based Learning"
author: "Pablo Montero-Manso"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, eval=TRUE,
  comment = "#>"
)
```
This page explains how to reproduce the results for our submission.
The first part is the methodological description of our methods. [The methodology can be seen here](M4_methodology.md)


#Authorship

 * Pablo Montero-Manso
 * Thiyanga Talagala
 * Rob J Hyndman
 * George Athanasopoulos
 
#Overview

The technical part of the reproducibility is divided in two sections.
First, the tools for producing the forecast of our method and second, a way of replicating the training of our model. It is divided in two parts because replicating the training is a very computationaly expensive process, so a pretrained model is provided. Also for very long time series, the actual calculation of there forecast can also computationally expensive, because 9 different forecasting methods are calculated independently, and some of these methods do exhaustive search on its parameters, which is time consuming.

#The model

Two R packages are provided as part of our submission, the `M4metalearning` package contains the functions for training new models and making the predictions.

The `M4metaresults` package is just a 'data' package containing the trained model used in ou submission, as well as the training set, explained in our [methodology page](M4_methodology.md) as well as the 'test' or 'final' dataset, which is the original M4 dataset but with the forecasts of the individual methods and the features of the series already extracted.

We first show how to reproduce the exact results of our submission and also how to easily use our trained model and provided tools to produce new forecast for any time series.

## Simple forecasting

The function `forecas_M4` is included in the M4metalearning package to simplify forecasting. `forecast_M4` uses the pretrained model of the `M4metaresults` package.
This takes as input a time series and its required forecasting horizon and outputs the mean and interval forecasts. It may be computationally expensive, especially for long time series (length>1000).

**NOTE: The results may slightly vary since one of the individual forecasting methods, `nnetar` uses random initialization. Nevertheless, the results should vary less than 0.1%.*

The following example shows how to produce forecasts for a example 'new' time series
and serveral of the ones in the M4 dataset.

````{r eval=FALSE}
#install the package if not already installed
devtools::install_github("rbojhyndman/M4metadata")
devtools::install_github("pmontman/M4metaresults")
````


````{r}
library(M4metalearning)
library(M4metaresults)
#we will showcase how to forecast a syntethic time series
#first, we generate the full series
set.seed(10-06-2018)
truex = (rnorm(60)) + seq(60)/10

#we subtract the last 10 observations to use it as 'true future' values
#and keep the rest as the input series in our method
h = 10
x <- head(truex, -h)
x <- ts(x, frequency = 1)

#forecasting with our method using our pretrained model in one line of code
#just the input series and the desired forecasting horizon
forec_result <- forecast_meta_M4(model_M4, x, h=h)
#show the output, the mean, upper and lower interval forecasts
print(forec_result, digits=2)
````

````{r example_forecast, fig.path='/docs/', fig.width=6, fig.height=5, fig.cap='example forecast'}
plot(truex, ylim=range(c(truex,unlist(forec_result))), type="l")
lines(c(x,forec_result$mean), col="blue")
lines(c(x,forec_result$upper), col="blue")
lines(c(x,forec_result$lower), col="blue")
lines(truex)
```

Any time series of the M4 dataset may be easily forecasted using our `forecast_meta_M4`
and the `M4comp2018` package containing the original M4 series.

````{r}
forec_M4_2018 <- forecast_meta_M4(model_M4,
                                  M4comp2018::M4[[2018]]$x,
                                  M4comp2018::M4[[2018]]$h)
print(forec_M4_2018, digits=2)

````

## Exact reproduction of the submitted forecasts

Calculating the individual forecast methods for the 100000 time series in the M4 dataset
is a very time consuming process (hours). One of the individual methods `nnetar` in the `forecast` R package produces random results which difficult reproducibiliy, for instance when running in a cluster. Training the learning model is also time consuming.

In order to facilitate the exact reproduction of the process, the individual forecast are already calculated in the (`M4metaresults`package)[https://github.com/pmontman/M4metaresults] and we show here how to apply our approach to the dataset of precalculated individual forecasts.

````{r eval=FALSE}
library(M4metalearning)
library(M4metaresults)
data <- create_feat_classif_problem(submission_M4)
times =system.time(
preds <- predict_selection_ensemble(model_M4, data$data))
times

replication_M4 <- ensemble_forecast(preds, submission_M4)


interval_M4 <- predict_interval(submission_M4,
                                get_M4_interval_weights())
````


#Reproducing the Training of the Model
